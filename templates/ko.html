{% extends "base.html" %}
{% load static %}
{% block title %}Kitchen Orders{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold mb-4">Kitchen Orders</h1>
<div class="container mx-auto h-screen overflow-hidden">
    <!-- CSRF Token Meta Tag -->
    <meta name="csrfmiddlewaretoken" content="{{ csrf_token }}"/>
    
    <!-- New scrollable container with hidden scrollbar -->
    <div class="orders-container h-full overflow-y-auto hide-scrollbar pb-36 pt-3">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-5 pt-2">
            {% for order in orders %}
            <div class="order-box bg-gray-800 shadow-lg rounded-lg p-4 relative transition-transform transform hover:scale-105" data-order-id="{{ order.pk }}">
                <div class="flex justify-between items-baseline mb-1">
                    <h2 class="text-lg font-bold text-white">Order #{{ order.order_id }}</h2>
                    <span class="text-xs text-gray-400">{{ order.status }}</span>
                </div>
                <p class="text-gray-400 mb-1 text-sm">Table: {{ order.table.number }}</p>
                <p class="text-gray-400 mb-1 text-sm">Date: {{ order.date }}</p>
                <p class="text-gray-400 mb-2 text-sm">Time: {{ order.time }}</p>
                <ul class="text-gray-400 mb-2 text-sm">
                    {% for item in order.items.all %}
                    <li>{{ item.name }} &times; {{ item.quantity }}</li>
                    {% endfor %}
                </ul>
                <div class="text-white font-semibold mb-2 text-sm">
                    Grand Total: ₹{{ order.grand_total }}
                </div>
                <button class="status-button bg-blue-500 text-white px-4 py-2 rounded transition-colors hover:bg-blue-600" data-state="start">Order Start</button>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<!-- Order Details Modal -->
<div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-[600px] max-h-[80vh] transform transition-all scale-95 opacity-0 overflow-y-auto shadow-lg" id="modalContent">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white" id="modalTitle">Order Details</h3>
            <button onclick="closeOrderDetailsModal()" class="text-gray-400 hover:text-white" aria-label="Close order details modal">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="orderDetailsContent" class="text-white space-y-4">
            <!-- Order details will be dynamically added here -->
            <div class="flex justify-end mt-4 gap-2">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="editOrder()">
                    Edit
                </button>
                <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="printOrder()">
                    Print
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .hide-scrollbar {
        -ms-overflow-style: none;  /* Internet Explorer 10+ */    
        scrollbar-width: none;     /* Firefox */
    }
    .hide-scrollbar::-webkit-scrollbar {
        display: none;            /* Safari and Chrome */
        width: 0;                 /* Hide scrollbar track */
    }
    .neon-yellow {
        box-shadow: 0 0 10px yellow, 0 0 20px yellow;
    }
    .neon-green {
        box-shadow: 0 0 10px green, 0 0 20px green;
    }
</style>
{% endblock %}
{% block scripts %}
<script src="{% static 'js/script.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle status button clicks
    const statusButtons = document.querySelectorAll('.status-button');
    statusButtons.forEach(button => {
        button.addEventListener('click', function() {
            const currentState = button.getAttribute('data-state');
            const orderBox = button.closest('.order-box');
            const orderId = orderBox.getAttribute('data-order-id');

            if (currentState === 'start') {
                // Change to 'Order Preparing'
                button.innerText = 'Order Preparing';
                button.setAttribute('data-state', 'preparing');
                orderBox.classList.add('neon-yellow');
            } else if (currentState === 'preparing') {
                // Change to 'Place Order'
                button.innerText = 'Place Order';
                button.setAttribute('data-state', 'place');
                orderBox.classList.remove('neon-yellow');
                orderBox.classList.add('neon-green');
            } else if (currentState === 'place') {
                // Show order details modal
                fetchOrderDetails(orderId);
            }
        });
    });
});

function fetchOrderDetails(orderId) {
    fetch(`/order-details/${orderId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showOrderDetailsModal(data.order);
            } else {
                alert('Failed to fetch order details: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while fetching the order details.');
        });
}

function showOrderDetailsModal(order) {
    const modalContent = document.getElementById('orderDetailsContent');
    modalContent.innerHTML = `
        <div><strong>Order ID:</strong> ${order.order_id}</div>
        <div><strong>Date:</strong> ${order.date}</div>
        <div><strong>Time:</strong> ${order.time}</div>
        <div><strong>Payment Type:</strong> ${order.payment_type}</div>
        <div><strong>Order Type:</strong> ${order.order_type}</div>
        <div><strong>Subtotal:</strong> ₹${order.subtotal}</div>
        <div><strong>GST Amount:</strong> ₹${order.gst_amount}</div>
        <div><strong>Grand Total:</strong> ₹${order.grand_total}</div>
        <div><strong>Items:</strong></div>
        <ul>
            ${order.items.map(item => `
                <li>${item.name} × ${item.quantity} ${item.customizations.length > 0 ? `(${item.customizations.map(c => c.name).join(', ')})` : ''}</li>
            `).join('')}
        </ul>
        <div class="flex justify-end mt-4 gap-2">
            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="editOrder()">
                Edit
            </button>
            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" onclick="printOrder('${encodeURIComponent(JSON.stringify(order))}')">
                Print
            </button>
        </div>
    `;

    const modal = document.getElementById('orderDetailsModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => {
        document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0');
        document.getElementById('modalContent').classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeOrderDetailsModal() {
    const modal = document.getElementById('orderDetailsModal');
    document.getElementById('modalContent').classList.remove('scale-100', 'opacity-100');
    document.getElementById('modalContent').classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
    }, 300);
}

function printOrder(encodedOrder) {
    const order = JSON.parse(decodeURIComponent(encodedOrder));
    const billWindow = window.open('', 'BILL', 'width=400,height=600');
    if (!billWindow) {
        console.error('Failed to open bill window');
        return;
    }
    const billContent = `
        <html>
        <head>
            <title>Thermal Bill</title>
            <style>
                body {
                    width: 58mm; /* Adjust to 80mm if needed */
                    font-family: monospace;
                    font-size: 12px;
                    margin: 0;
                    padding: 10px;
                }
                .header, .footer {
                    text-align: center;
                }
                .header img {
                    max-width: 100px;
                    margin-bottom: 10px;
                }
                .details {
                    margin: 10px 0;
                }
                .details div {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 5px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 10px 0;
                }
                table, th, td {
                    border: 1px dashed #000;
                }
                th, td {
                    padding: 5px;
                    text-align: left;
                }
                .total {
                    margin: 10px 0;
                    display: flex;
                    justify-content: space-between;
                    font-size: 14px;
                }
                .thank-you {
                    margin-top: 20px;
                    text-align: center;
                    font-size: 14px;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <img src="https://yourcompany.com/logo.png" alt="Company Logo">
                <h2>Your Company Name</h2>
                <p>1234 Street Name, City, State</p>
                <p>Phone: (123) 456-7890 | Email: info@yourcompany.com</p>
            </div>
            
            <div class="details">
                <div>
                    <span>Order ID:</span>
                    <span>${order.order_id}</span>
                </div>
                <div>
                    <span>Date:</span>
                    <span>${order.date}</span>
                </div>
                <div>
                    <span>Time:</span>
                    <span>${order.time}</span>
                </div>
                ${order.table_number ? `
                <div>
                    <span>Table No.:</span>
                    <span>${order.table_number}</span>
                </div>
                ` : ''}
                <div>
                    <span>Payment:</span>
                    <span>${order.payment_type}</span>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Qty</th>
                        <th>Price (₹)</th>
                        <th>Total (₹)</th>
                    </tr>
                </thead>
                <tbody>
                    ${order.items.map(item => `
                        <tr>
                            <td>${item.name}${item.customizations.length > 0 ? ` (${item.customizations.map(c => c.name).join(', ')})` : ''}</td>
                            <td>${item.quantity}</td>
                            <td>₹${item.price ? parseFloat(item.price).toFixed(2) : '0.00'}</td>
                            <td>₹${item.total_price ? parseFloat(item.total_price).toFixed(2) : '0.00'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="total">
                <span>Subtotal:</span>
                <span>₹${order.subtotal}</span>
            </div>
            <div class="total">
                <span>GST (18%):</span>
                <span>₹${order.gst_amount}</span>
            </div>
            <div class="total">
                <strong>Grand Total:</strong>
                <strong>₹${order.grand_total}</strong>
            </div>
            
            <div class="thank-you">
                <p>Thank you for dining with us!</p>
                <p>Please come again.</p>
            </div>
        </body>
        </html>
    `;
    billWindow.document.write(billContent);
    billWindow.document.close();
    billWindow.focus();
    billWindow.print();

    // Store the order data in the Order table in the database
    function storeOrder(order) {
        fetch('/store-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                order_id: order.order_id,
                items: order.items,
                payment_type: order.payment_type,
                subtotal: order.subtotal,
                gst_amount: order.gst_amount,
                grand_total: order.grand_total,
                order_type: order.order_type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Order stored successfully!');
            } else if (data.error && data.error.includes('duplicate key value violates unique constraint')) {
                // Handle duplicate order ID by generating a new one
                order.order_id = Date.now().toString();
                storeOrder(order);
            } else {
                console.error('Failed to store order:', data.error);
            }
        })
        .catch(error => {
            console.error('Error storing order:', error);
        })
        .finally(() => {
            // Remove the order box from the page using the correct order ID
            const orderBox = document.querySelector(`.order-box[data-order-id="${order.pk}"]`);
            if (orderBox) {
                orderBox.remove();
            }
        });
    }

    storeOrder(order);

    // Close the order details modal
    closeOrderDetailsModal();
}
</script>
{% endblock %}